name: Deploy to Kubernetes

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'qa'
        type: choice
        options:
          - qa
          - prd

jobs:
  build_and_deploy:
    runs-on: 
      - self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        repository: jamilusman/webserver

    - name: Set Execution Policy
      shell: powershell
      run: |
        Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope Process

    - name: Install Docker
      shell: powershell
      run: |
        $ErrorActionPreference = 'Stop'
        # Download Docker Desktop installer
        Invoke-WebRequest -Uri "https://desktop.docker.com/win/stable/Docker%20Desktop%20Installer.exe" -OutFile "$env:TEMP\DockerDesktopInstaller.exe"
        # Install Docker Desktop and log the output
        Start-Process -Wait -FilePath "$env:TEMP\DockerDesktopInstaller.exe" -ArgumentList "install", "/quiet", "/norestart" -NoNewWindow -RedirectStandardOutput "$env:TEMP\docker_install.log" -RedirectStandardError "$env:TEMP\docker_install_error.log"
        # Wait for Docker to start
        Start-Sleep -Seconds 60
        # Verify Docker installation
        docker --version
        docker run hello-world
        # Output log files for debugging
        Get-Content "$env:TEMP\docker_install.log"
        Get-Content "$env:TEMP\docker_install_error.log"

    - name: Install Minikube
      shell: powershell
      run: |
        # Download Minikube binary
        Invoke-WebRequest -Uri "https://storage.googleapis.com/minikube/releases/latest/minikube-windows-amd64.exe" -OutFile "$env:USERPROFILE\minikube.exe"
        # Move Minikube to PATH
        Move-Item -Path "$env:USERPROFILE\minikube.exe" -Destination "$env:ProgramFiles\Minikube\minikube.exe"
        # Add Minikube to PATH
        [System.Environment]::SetEnvironmentVariable('PATH', "$env:ProgramFiles\Minikube", [System.EnvironmentVariableTarget]::Machine)
        # Verify Minikube installation
        minikube version

    - name: Set up Minikube
      shell: powershell
      run: |
        minikube start --driver=docker
        kubectl config use-context minikube
        # Verify Minikube is running
        kubectl cluster-info
        kubectl get nodes

    - name: Try the cluster !
      run: kubectl get pods -A
    - name: Build image
      run: |
          export SHELL=/bin/bash
          eval $(minikube -p minikube docker-env)
          docker build -f ./Dockerfile -t jamilusman/nginx:latest .
          echo -n "verifying images:"
          docker images

    - name: Deploy to Kubernetes
      run: |

        helm upgrade webapp-release-qa webapp/ --values webapp/values.yaml -f webapp/values-qa.yaml -n qa

        # Use Helm to deploy with the appropriate values file
        # helm upgrade --install my-release ./charts \
        #   --namespace ${{ github.event.inputs.environment }} \
        #   --values values-${{ github.event.inputs.environment }}.yaml

    - name: Apply Kubernetes manifests
      run: |
        kubectl apply -f templates/configmap.yaml
        kubectl apply -f templates/deployment.yaml
        kubectl apply -f templates/service.yaml

    # - name: Verify deployment
    #   run: |
    #     kubectl rollout status deployment/nginx-deployment
    #     kubectl get pods