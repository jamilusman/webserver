name: Deploy to Kubernetes

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'qa'
        type: choice
        options:
          - qa
          - prd

jobs:
  build_and_deploy:
    runs-on: 
      - self-hosted

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    # - name: Build Docker image
    #   run: |
    #     docker build -t ${{ secrets.REGISTRY_URL }}/my-nginx-image:${{ github.sha }} .

    # - name: Log in to Docker Hub
    #   uses: docker/login-action@v2
    #   with:
    #     username: ${{ secrets.DOCKER_USERNAME }}
    #     password: ${{ secrets.DOCKER_PASSWORD }}

    # - name: Push Docker image
    #   run: |
    #     docker push ${{ secrets.REGISTRY_URL }}/my-nginx-image:${{ github.sha }}

    - name: Start Minikube
      uses: minikube/action@v1

    - name: Try the cluster !
      run: kubectl get pods -A
    - name: Build image
      run: |
          export SHELL=/bin/bash
          eval $(minikube -p minikube docker-env)
          docker build -f ./Dockerfile -t jamilusman/nginx:latest .
          echo -n "verifying images:"
          docker images

    - name: Deploy to Kubernetes
      run: |

        helm upgrade webapp-release-qa webapp/ --values webapp/values.yaml -f webapp/values-qa.yaml -n qa

        # Use Helm to deploy with the appropriate values file
        # helm upgrade --install my-release ./charts \
        #   --namespace ${{ github.event.inputs.environment }} \
        #   --values values-${{ github.event.inputs.environment }}.yaml

    - name: Apply Kubernetes manifests
      run: |
        kubectl apply -f templates/configmap.yaml
        kubectl apply -f templates/deployment.yaml
        kubectl apply -f templates/service.yaml

    # - name: Verify deployment
    #   run: |
    #     kubectl rollout status deployment/nginx-deployment
    #     kubectl get pods